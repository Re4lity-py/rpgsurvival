<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Survival RPG ULTIMATE - COMPLET</title>
<style>
    /* --- CSS GLOBAL --- */
    * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', sans-serif; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #111; overflow: hidden; }
    
    #gameCanvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; cursor: crosshair; }

    /* --- UI HUD --- */
    .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    
    .hud-container {
        position: absolute; top: 10px; left: 10px;
        display: flex; flex-direction: column; gap: 10px;
        pointer-events: auto;
    }

    .hud-box {
        background: rgba(20,20,20,0.95); color: #fff; padding: 10px; 
        border-radius: 8px; border: 2px solid #555; 
        font-size: 12px; font-weight: bold; min-width: 180px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.5);
    }

    .hud-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .res-icon { display: inline-block; width: 15px; text-align: center; margin-right: 5px; }

    /* BARRE XP & HP */
    .bar-container { width: 100%; height: 8px; background: #333; border-radius: 4px; margin-top: 2px; overflow: hidden; }
    .bar-fill { height: 100%; transition: width 0.2s; }
    .hp-fill { background: #e74c3c; }
    .xp-fill { background: #f1c40f; }

    /* MINIMAP */
    #minimap-container {
        position: absolute; top: 10px; right: 10px;
        border: 2px solid #fff; border-radius: 4px; background: #000; display: none; pointer-events: auto;
    }

    /* QUEST BOX */
    .quest-box { 
        position: absolute; top: 220px; right: 10px;
        background: rgba(0,0,0,0.7); color: #f1c40f; padding: 10px; 
        border-radius: 5px; border-left: 4px solid #f1c40f; 
        font-size: 14px; max-width: 250px; text-align: right; pointer-events: none; 
    }

    /* HINT */
    .controls-hint {
        position: absolute; bottom: 10px; right: 10px;
        color: rgba(255,255,255,0.6); font-size: 12px; pointer-events: none;
        text-shadow: 1px 1px 0 #000;
    }

    /* MODALS (Menus) */
    .modal { 
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
        background: #2c3e50; width: 90%; max-width: 600px; max-height: 90vh;
        border: 3px solid #fff; border-radius: 10px; display: none; 
        z-index: 50; padding: 15px; color: #fff; pointer-events: auto; 
        box-shadow: 0 0 50px rgba(0,0,0,0.8); overflow-y: auto; 
    }
    .modal h2 { text-align: center; color: #f1c40f; border-bottom: 1px solid #555; padding-bottom: 10px; margin-top: 0; }
    
    /* CRAFT ITEMS */
    .craft-item { 
        display: flex; justify-content: space-between; align-items: center; 
        background: rgba(0,0,0,0.3); padding: 10px; margin-bottom: 8px; 
        border-radius: 6px; border: 1px solid #444; 
    }
    .craft-desc small { color: #aaa; display: block; margin-top: 3px; }
    .cost-text { color: #e74c3c; font-weight: bold; font-size: 0.85em; }

    /* SKILL ITEMS */
    .skill-row {
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px; border-bottom: 1px solid #444;
    }

    /* BUTTONS */
    .btn { 
        background: #27ae60; color: white; border: none; padding: 8px 16px; 
        border-radius: 4px; font-weight: bold; border-bottom: 3px solid #1e8449; 
        cursor: pointer; text-transform: uppercase; font-size: 12px;
    }
    .btn:hover { background: #2ecc71; }
    .btn:active { border-bottom: 0; transform: translateY(3px); }
    .btn:disabled { background: #7f8c8d; border-bottom: 3px solid #555; cursor: not-allowed; opacity: 0.6; }
    .btn-close { width: 100%; margin-top: 15px; background: #c0392b; border-bottom-color: #922b21; }

    /* DEATH SCREEN */
    #death-screen { background: rgba(150, 0, 0, 0.9); text-align: center; }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<div id="night-overlay" style="position:absolute;top:0;left:0;width:100%;height:100%;background:black;pointer-events:none;opacity:0;z-index:5;"></div>

<div class="ui-layer">
    <div class="hud-container">
        <div class="hud-box">
            <div class="hud-row">
                <span>‚ù§Ô∏è VIE <span id="hud-hp-text">100/100</span></span>
            </div>
            <div class="bar-container"><div id="hud-hp-bar" class="bar-fill hp-fill" style="width:100%"></div></div>
            
            <div class="hud-row" style="margin-top:8px;">
                <span>‚≠ê NIV <span id="hud-lvl">1</span></span>
                <span style="font-size:10px; color:#f1c40f;">PTS: <span id="hud-sp">0</span></span>
            </div>
            <div class="bar-container"><div id="hud-xp-bar" class="bar-fill xp-fill" style="width:0%"></div></div>
        </div>

        <div class="hud-box">
            <div class="hud-row"><span class="res-icon">ü™µ</span> Bois <span id="res-wood">0</span></div>
            <div class="hud-row"><span class="res-icon">ü™®</span> Pierre <span id="res-stone">0</span></div>
            <div class="hud-row"><span class="res-icon">üü°</span> Or <span id="res-gold">0</span></div>
            <div class="hud-row"><span class="res-icon">‚ö™</span> Fer <span id="res-iron">0</span></div>
            <div class="hud-row"><span class="res-icon">üî¥</span> Rubis <span id="res-ruby">0</span></div>
            <div class="hud-row"><span class="res-icon">‚ö´</span> Obsidienne <span id="res-obsidian">0</span></div>
        </div>
    </div>

    <div id="minimap-container">
        <canvas id="minimapCanvas" width="150" height="150"></canvas>
        <div style="text-align:center; color:#fff; font-size:10px; background:#222;">CARTE (VerrMaj)</div>
    </div>

    <div class="quest-box">
        <div class="quest-title">OBJECTIF</div>
        <div id="quest-txt">Chargement...</div>
    </div>

    <div class="controls-hint">
        [TAB] Craft | [C] Comp√©tences | [ZQSD] Bouger | [Clic] Action | [¬≤] Aide
    </div>
</div>

<div id="craft-menu" class="modal">
    <h2>üõ†Ô∏è ARTISANAT</h2>
    
    <div class="craft-item" style="border-left: 4px solid #f39c12;">
        <div class="craft-desc"><strong>üè† MAISON</strong><br><small>Point de respawn.</small><span class="cost-text" id="c-house">50 Bois</span></div>
        <button class="btn" onclick="game.craft('house')">B√ÇTIR</button>
    </div>
    <div class="craft-item" style="border-left: 4px solid #9b59b6;">
        <div class="craft-desc"><strong>üåÄ PORTAIL GROTTE</strong><br><small>Acc√®s au Dragon.</small><span class="cost-text" id="c-portal">50 Rubis</span></div>
        <button class="btn" onclick="game.craft('portal')">CR√âER</button>
    </div>
    
    <hr style="border-color:#444; opacity:0.5;">

    <div class="craft-item">
        <div class="craft-desc"><strong>üß± MUR</strong><br><small>Bloque les ennemis.</small><span class="cost-text">10 Pierre</span></div>
        <button class="btn" onclick="game.craft('wall')">POSER</button>
    </div>
    <div class="craft-item">
        <div class="craft-desc"><strong>üì¶ COFFRE</strong><br><small>D√©coration (pour l'instant).</small><span class="cost-text">20 Bois + 5 Fer</span></div>
        <button class="btn" onclick="game.craft('chest')">POSER</button>
    </div>

    <hr style="border-color:#444; opacity:0.5;">

    <div class="craft-item">
        <div class="craft-desc"><strong>‚öîÔ∏è √âP√âE</strong> <small id="lvl-sword">Niv 1</small><br><span class="cost-text" id="c-sword">...</span></div>
        <button class="btn" onclick="game.craft('sword')">UP</button>
    </div>
    <div class="craft-item">
        <div class="craft-desc"><strong>üõ°Ô∏è ARMURE</strong> <small id="lvl-armor">Niv 0</small><br><span class="cost-text" id="c-armor">...</span></div>
        <button class="btn" onclick="game.craft('armor')">UP</button>
    </div>
    <div class="craft-item">
        <div class="craft-desc"><strong>üëû BOTTES</strong> <small id="lvl-boots">Niv 0</small><br><span class="cost-text" id="c-boots">...</span></div>
        <button class="btn" onclick="game.craft('boots')">UP</button>
    </div>
    <div class="craft-item">
        <div class="craft-desc"><strong>‚õèÔ∏è PIOCHE</strong> <small id="lvl-pick">Niv 1</small><br><span class="cost-text" id="c-pick">...</span></div>
        <button class="btn" onclick="game.craft('pick')">UP</button>
    </div>
    <div class="craft-item">
        <div class="craft-desc"><strong>ü™ì HACHE</strong> <small id="lvl-axe">Niv 1</small><br><span class="cost-text" id="c-axe">...</span></div>
        <button class="btn" onclick="game.craft('axe')">UP</button>
    </div>

    <button class="btn btn-close" onclick="toggleUI('craft')">FERMER</button>
</div>

<div id="skills-menu" class="modal">
    <h2>üí™ COMP√âTENCES</h2>
    <p style="text-align:center; color:#f1c40f;">POINTS DISPONIBLES : <span id="skill-points-display" style="font-size:1.5em;">0</span></p>
    
    <div class="skill-row">
        <span>‚öîÔ∏è FORCE (D√©g√¢ts) <br><small style="color:#aaa;">Niv actuel: <span id="s-str">1</span></small></span>
        <button class="btn" onclick="game.upgradeSkill('str')">+</button>
    </div>
    <div class="skill-row">
        <span>üèÉ VITESSE (Move) <br><small style="color:#aaa;">Niv actuel: <span id="s-spd">1</span></small></span>
        <button class="btn" onclick="game.upgradeSkill('spd')">+</button>
    </div>
    <div class="skill-row">
        <span>üéí R√âCOLTE (Ressources) <br><small style="color:#aaa;">Niv actuel: <span id="s-har">1</span></small></span>
        <button class="btn" onclick="game.upgradeSkill('har')">+</button>
    </div>
    <div class="skill-row">
        <span>‚ù§Ô∏è SANT√â (PV Max) <br><small style="color:#aaa;">Niv actuel: <span id="s-vit">1</span></small></span>
        <button class="btn" onclick="game.upgradeSkill('vit')">+</button>
    </div>

    <button class="btn btn-close" onclick="toggleUI('skills')">FERMER</button>
</div>

<div id="controls-menu" class="modal">
    <h2>COMMANDES</h2>
    <ul style="list-style:none; padding:0; line-height:2;">
        <li><b>Z Q S D</b> : Se d√©placer</li>
        <li><b>Clic Gauche</b> : Attaquer / R√©colter / Interagir</li>
        <li><b>TAB</b> : Menu Artisanat</li>
        <li><b>C</b> : Menu Comp√©tences</li>
        <li><b>Verr Maj</b> : Minimap On/Off</li>
    </ul>
    <button class="btn btn-close" onclick="toggleUI('controls')">FERMER</button>
</div>

<div id="death-screen" class="modal">
    <h2 style="color:red;">VOUS √äTES MORT</h2>
    <p>Dommage...</p>
    <button class="btn" id="btn-respawn" onclick="respawn()" style="display:none;">RESPAWN MAISON</button>
    <button class="btn" onclick="location.reload()" style="background:#c0392b; margin-top:10px;">RECOMMENCER</button>
</div>

<script>
/* ==================================================================
   CONFIG & ASSETS
   ================================================================== */
const CANVAS = document.getElementById('gameCanvas');
const CTX = CANVAS.getContext('2d', { alpha: false });
const W_W = 100000, W_H = 100000; // Monde 100k x 100k
const CHUNK = 8000;

const PALETTE = [
    'transparent', '#000', '#fff', '#8b4513', '#27ae60', '#7f8c8d', '#c0392b', 
    '#f1c40f', '#3498db', '#9b59b6', '#bdc3c7', '#2c3e50', '#145a32', '#d35400'
];
// 11 = Obsidian color, 13 = Lava/Orange

const PIXELS = {
    PLAYER: [[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,6,6,1,0,0,0,0,0,0],[0,0,0,0,0,1,6,2,2,6,1,0,0,0,0,0],[0,0,0,0,1,6,2,2,2,2,6,1,0,0,0,0],[0,0,0,1,6,2,2,2,2,2,6,1,0,0,0,0],[0,0,0,1,3,3,1,1,1,1,3,1,0,0,0,0],[0,0,0,0,1,3,1,1,1,1,3,1,0,0,0,0],[0,0,0,0,1,3,3,3,3,3,3,1,0,0,0,0],[0,0,0,0,1,3,3,3,3,3,3,1,0,0,0,0],[0,0,0,0,1,2,2,1,1,2,2,1,0,0,0,0],[0,0,0,1,2,2,1,1,1,1,2,2,1,0,0,0],[0,0,1,3,3,1,0,0,0,0,1,3,3,1,0,0],[0,0,1,3,3,1,0,0,0,0,1,3,3,1,0,0],[0,0,1,3,3,1,0,0,0,0,1,3,3,1,0,0],[0,0,3,1,1,3,0,0,0,0,3,1,1,3,0,0],[0,3,1,0,0,1,3,0,0,3,1,0,0,1,3,0]],
    TREE: [[0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0],[0,0,0,0,0,4,4,4,4,4,4,0,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,4,4,0,0,0,0],[0,0,0,4,4,4,12,12,12,12,4,4,4,0,0,0],[0,0,4,4,4,4,4,4,4,4,4,4,4,4,0,0],[0,4,4,4,4,12,4,4,4,4,12,4,4,4,4,0],[4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],[0,4,4,4,4,4,4,4,4,4,4,4,4,4,4,0],[0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0]],
    STONE: [[0,0,0,0,5,5,5,5,5,5,0,0,0,0,0,0],[0,0,5,5,5,5,5,5,5,5,5,5,0,0,0,0],[0,5,5,5,5,1,1,5,5,1,1,5,5,0,0,0],[5,5,5,5,5,1,1,5,5,1,1,5,5,5,0,0],[5,5,1,1,5,5,5,5,5,5,5,5,5,5,0,0],[0,5,5,5,5,5,5,5,5,5,5,5,0,0,0,0],[0,0,5,5,5,5,5,5,5,5,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],
    // Simple square fills for others to save space, rendered dynamically if missing
    WALL: [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0],[0,5,10,10,10,5,10,10,10,5,10,10,10,5,5,0],[0,5,10,10,10,5,10,10,10,5,10,10,10,5,5,0],[0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0],[0,5,10,10,10,5,10,10,10,5,10,10,10,5,5,0],[0,5,10,10,10,5,10,10,10,5,10,10,10,5,5,0],[0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0],[0,5,10,10,10,5,10,10,10,5,10,10,10,5,5,0],[0,5,10,10,10,5,10,10,10,5,10,10,10,5,5,0],[0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0],[0,5,10,10,10,5,10,10,10,5,10,10,10,5,5,0],[0,5,10,10,10,5,10,10,10,5,10,10,10,5,5,0],[0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0],[0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],
    CHEST: [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,3,3,3,3,3,3,3,3,3,3,3,0,0,0],[0,0,3,7,7,3,7,7,7,3,7,7,3,0,0,0],[0,0,3,7,7,3,7,7,7,3,7,7,3,0,0,0],[0,0,3,3,3,3,3,3,3,3,3,3,3,0,0,0],[0,0,3,3,3,3,7,7,7,3,3,3,3,0,0,0],[0,0,3,3,3,3,7,7,7,3,3,3,3,0,0,0],[0,0,3,3,3,3,3,3,3,3,3,3,3,0,0,0],[0,0,3,7,7,3,7,7,7,3,7,7,3,0,0,0],[0,0,3,7,7,3,7,7,7,3,7,7,3,0,0,0],[0,0,3,7,7,3,7,7,7,3,7,7,3,0,0,0],[0,0,3,3,3,3,3,3,3,3,3,3,3,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],
    PORTAL: [[0,0,0,0,9,9,9,9,9,9,0,0,0,0,0,0],[0,0,9,9,8,8,8,8,8,8,9,9,0,0,0,0],[0,9,8,8,2,2,2,2,2,2,8,8,9,0,0,0],[0,9,8,2,8,8,8,8,8,8,2,8,9,0,0,0],[9,8,2,8,8,8,8,8,8,8,8,2,8,9,0,0],[9,8,2,8,8,8,8,8,8,8,8,2,8,9,0,0],[9,8,2,8,8,8,8,8,8,8,8,2,8,9,0,0],[9,8,2,8,8,8,8,8,8,8,8,2,8,9,0,0],[9,8,2,8,8,8,8,8,8,8,8,2,8,9,0,0],[9,8,2,8,8,8,8,8,8,8,8,2,8,9,0,0],[9,8,2,8,8,8,8,8,8,8,8,2,8,9,0,0],[0,9,8,2,8,8,8,8,8,8,2,8,9,0,0,0],[0,9,8,8,2,2,2,2,2,2,8,8,9,0,0,0],[0,0,9,9,8,8,8,8,8,8,9,9,0,0,0,0],[0,0,0,0,9,9,9,9,9,9,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],
    OBSIDIAN: [[0,0,0,0,0,0,11,11,0,0,0,0,0,0,0,0],[0,0,0,0,11,11,11,11,11,0,0,0,0,0,0,0],[0,0,0,11,1,1,11,11,1,11,0,0,0,0,0,0],[0,0,11,1,11,11,1,1,11,11,11,0,0,0,0,0],[0,0,11,11,11,11,11,11,11,1,11,0,0,0,0,0],[0,0,0,11,11,11,1,1,11,11,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]
};

// Biomes
const BIOMES = {
    FOREST: { bg: '#27ae60', tree: 'TREE', rock: 'STONE', mob: null },
    DESERT: { bg: '#e67e22', tree: null, rock: 'ROCK_GOLD', mob: 'SCORPION' }, // Need generic logic for gold
    SNOW:   { bg: '#bdc3c7', tree: null, rock: 'IRON', mob: 'WOLF' },
    VOLCANO:{ bg: '#c0392b', tree: null, rock: 'RUBY', mob: 'DEMON' },
    CAVE:   { bg: '#2d2d2d', tree: null, rock: 'OBSIDIAN', mob: 'BAT' }
};

// Quetes
const QUESTS = [
    { id:0, txt:"R√©colter 10 BOIS", t:'wood', n:10 },
    { id:1, txt:"R√©colter 10 PIERRE", t:'stone', n:10 },
    { id:2, txt:"Craft: MAISON", t:'house', n:1 },
    { id:3, txt:"Craft: HACHE 2", t:'axe', n:2 },
    { id:4, txt:"Trouver D√âSERT (Or)", t:'gold', n:5 },
    { id:5, txt:"Craft: √âP√âE 2", t:'sword', n:2 },
    { id:6, txt:"Trouver NEIGE (Fer)", t:'iron', n:5 },
    { id:7, txt:"Tuer 3 LOUPS", t:'kill_wolf', n:3 },
    { id:8, txt:"Craft: PORTAIL (50 Rubis)", t:'portal', n:1 },
    { id:9, txt:"ALLER DANS LA GROTTE", t:'enter_cave', n:1 },
    { id:10,txt:"TUER LE DRAGON", t:'kill_dragon', n:1 },
    { id:11,txt:"TUER LE ROI D√âMON", t:'kill_boss', n:1 },
    { id:12,txt:"MA√éTRE DU JEU !", t:'win', n:0 }
];

/* ==================================================================
   GAME STATE
   ================================================================== */
let game = {
    player: { x:15000, y:15000, hp:100, maxHp:100, xp:0, lvl:1, nextXp:100, sp:0, speed:4, size:20, angle:0, iframes:0, skills:{str:1, spd:1, har:1, vit:1} },
    inv: { wood:0, stone:0, gold:0, iron:0, ruby:0, obsidian:0, house:0, axe:1, pick:1, sword:1, armor:0, boots:0 },
    portal: { built: false, x:0, y:0 },
    objs: [],
    particles: [],
    quest: { id:0, prog:0 },
    day: 0,
    cam: { x:0, y:0 }
};

let keys = {};
let uiState = { craft:false, skills:false, controls:false, map:false };
let lastTime = 0;
let isRunning = true;

/* ==================================================================
   INIT & GENERATION
   ================================================================== */
function init() {
    CANVAS.width = window.innerWidth;
    CANVAS.height = window.innerHeight;
    generateWorld();
    setupEvents();
    updateUI();
    requestAnimationFrame(loop);
}

function getBiome(x, y) {
    if (x < 10000 && y < 10000) return 'CAVE';
    if (x > W_W - 15000 && y > W_H - 15000) return 'VOLCANO';
    if (y > W_H - 10000) return 'SNOW';
    if (x > W_W - 10000) return 'DESERT';
    return 'FOREST';
}

function createObj(type, x, y) {
    let o = { type:type, x:x, y:y, w:40, h:40, hp:1, mHp:1, solid:false, host:false, asset:'STONE' };
    
    // RESSOURCES
    if(type==='tree') { o.asset='TREE'; o.hp=15; o.solid=true; o.w=60; o.h=60; }
    else if(type==='stone') { o.asset='STONE'; o.hp=25; o.solid=true; }
    else if(type==='gold') { o.asset='STONE'; o.color='#f1c40f'; o.hp=40; o.solid=true; } // Placeholder asset color
    else if(type==='iron') { o.asset='STONE'; o.color='#bdc3c7'; o.hp=50; o.solid=true; }
    else if(type==='ruby') { o.asset='STONE'; o.color='#e91e63'; o.hp=60; o.solid=true; }
    else if(type==='obsidian') { o.asset='OBSIDIAN'; o.hp=80; o.solid=true; }

    // MOBS
    else if(type==='slime') { o.asset='PLAYER'; o.color='#2ecc71'; o.hp=30; o.host=true; o.dmg=5; o.xp=10; }
    else if(type==='scorpion') { o.asset='PLAYER'; o.color='#e67e22'; o.hp=60; o.host=true; o.dmg=10; o.xp=20; }
    else if(type==='wolf') { o.asset='PLAYER'; o.color='#95a5a6'; o.hp=90; o.host=true; o.dmg=15; o.xp=30; }
    else if(type==='demon') { o.asset='PLAYER'; o.color='#c0392b'; o.hp=150; o.host=true; o.dmg=20; o.xp=50; }
    else if(type==='bat') { o.asset='PLAYER'; o.color='#555'; o.hp=80; o.host=true; o.dmg=12; o.xp=40; }
    
    // BOSS
    else if(type==='boss') { o.asset='PLAYER'; o.color='#922b21'; o.hp=1000; o.host=true; o.dmg=30; o.xp=500; o.w=80; o.h=80; o.isBoss=true; }
    else if(type==='dragon') { o.asset='PLAYER'; o.color='#8e44ad'; o.hp=2500; o.host=true; o.dmg=50; o.xp=1000; o.w=100; o.h=100; o.isBoss=true; }

    // STRUCTURES
    else if(type==='house') { o.asset='HOUSE_LVL1'; o.hp=9999; o.solid=true; o.w=80; o.h=80; }
    else if(type==='wall') { o.asset='WALL'; o.hp=200; o.solid=true; }
    else if(type==='chest') { o.asset='CHEST'; o.hp=100; o.solid=true; }
    else if(type==='portal') { o.asset='PORTAL'; o.hp=9999; o.solid=true; o.w=60; o.h=60; o.link='cave'; }
    else if(type==='exit_portal') { o.asset='PORTAL'; o.hp=9999; o.solid=true; o.w=60; o.h=60; o.link='home'; }

    o.mHp = o.hp;
    game.objs.push(o);
}

function generateWorld() {
    game.objs = [];
    
    // Helper spawn
    const spawn = (t, n, biome) => {
        let c = 0;
        while(c < n) {
            let x = Math.random() * W_W, y = Math.random() * W_H;
            let b = getBiome(x,y);
            // Foret safe zone
            if(biome==='FOREST' && (x>30000 || y>30000)) continue;
            // Grotte zone exclusive
            if(biome!=='CAVE' && b==='CAVE') continue;
            if(biome==='CAVE' && b!=='CAVE') continue;
            // Autres biomes
            if(biome!=='FOREST' && biome!=='CAVE' && b!==biome) continue;
            
            createObj(t, x, y);
            c++;
        }
    };

    // Foret
    spawn('tree', 3000, 'FOREST');
    spawn('stone', 1000, 'FOREST');
    spawn('slime', 200, 'FOREST');

    // Desert
    spawn('gold', 800, 'DESERT');
    spawn('scorpion', 400, 'DESERT');

    // Neige
    spawn('iron', 800, 'SNOW');
    spawn('wolf', 400, 'SNOW');

    // Volcan
    spawn('ruby', 500, 'VOLCANO');
    spawn('demon', 300, 'VOLCANO');
    createObj('boss', 98000, 98000); // Roi Demon

    // Grotte
    spawn('obsidian', 600, 'CAVE');
    spawn('bat', 400, 'CAVE');
    createObj('dragon', 5000, 5000); // Dragon
    createObj('exit_portal', 2000, 2000); // Sortie
}

/* ==================================================================
   UPDATE & LOGIC
   ================================================================== */
function loop(t) {
    if(!isRunning) return;
    let dt = (t - lastTime)/1000;
    lastTime = t;
    update(dt);
    draw();
    requestAnimationFrame(loop);
}

function update(dt) {
    // Mouvements
    let dx=0, dy=0;
    let spd = game.player.speed + (game.player.skills.spd * 0.5) + (game.inv.boots * 0.5);
    if(keys['z'] || keys['w']) dy = -1;
    if(keys['s']) dy = 1;
    if(keys['q'] || keys['a']) dx = -1;
    if(keys['d']) dx = 1;

    if(dx||dy) {
        let l = Math.sqrt(dx*dx+dy*dy);
        // Tentative mouvement X
        let nx = game.player.x + (dx/l)*spd*60*dt;
        if(!checkCol(nx, game.player.y)) game.player.x = Math.max(0, Math.min(W_W, nx));
        // Tentative mouvement Y
        let ny = game.player.y + (dy/l)*spd*60*dt;
        if(!checkCol(game.player.x, ny)) game.player.y = Math.max(0, Math.min(W_H, ny));
    }

    game.cam.x = game.player.x - CANVAS.width/2;
    game.cam.y = game.player.y - CANVAS.height/2;

    // Iframes
    if(game.player.iframes > 0) game.player.iframes -= dt;

    // Mobs Logic
    game.objs.forEach(o => {
        if(o.host) {
            let d = Math.hypot(game.player.x - o.x, game.player.y - o.y);
            if(d < 400) { // Aggro
                let ang = Math.atan2(game.player.y - o.y, game.player.x - o.x);
                o.x += Math.cos(ang) * 2; // Mob speed fixe pour simplifier
                o.y += Math.sin(ang) * 2;

                if(d < 30 && game.player.iframes <= 0) {
                    game.player.hp -= Math.max(0, o.dmg - (game.inv.armor*2));
                    game.player.iframes = 0.5;
                    spawnText(`-${o.dmg}`, game.player.x, game.player.y, 'red');
                    updateUI();
                    if(game.player.hp<=0) endGame();
                }
            }
        }
    });

    // Jour/Nuit
    game.day += dt * 0.02;
    let darkness = 0;
    if(Math.sin(game.day) < 0) darkness = Math.abs(Math.sin(game.day)) * 0.7;
    document.getElementById('night-overlay').style.opacity = darkness;
}

function checkCol(x, y) {
    return game.objs.some(o => o.solid && Math.abs(x - o.x) < 30 && Math.abs(y - o.y) < 30);
}

function action() {
    // Interaction / Attaque
    let hit = false;
    // Cherche cible proche souris ou devant ? On fait simple : autour du joueur
    // Priorit√© : Portail > Ennemi > Ressource
    
    // 1. Portail
    let portal = game.objs.find(o => (o.type==='portal' || o.type==='exit_portal') && Math.hypot(game.player.x-o.x, game.player.y-o.y) < 60);
    if(portal) {
        if(portal.link === 'cave') {
            game.player.x = 2000; game.player.y = 2000; // Entr√©e grotte
            checkQuest('enter_cave', 1);
            spawnText("GROTTE !", game.player.x, game.player.y, '#9b59b6');
        } else {
            game.player.x = game.portal.x; game.player.y = game.portal.y; // Retour
            spawnText("RETOUR !", game.player.x, game.player.y, '#2ecc71');
        }
        return;
    }

    // 2. Combat / Recolte
    let range = 60;
    let dmg = (game.inv.sword * 3) + (game.player.skills.str * 2);
    let toolPwr = { tree: game.inv.axe, stone: game.inv.pick, gold: game.inv.pick, iron: game.inv.pick, ruby: game.inv.pick, obsidian: game.inv.pick };

    game.objs.forEach((o, i) => {
        if(Math.hypot(game.player.x - o.x, game.player.y - o.y) < range) {
            if(o.type === 'house') return; // Pas taper maison
            
            let d = dmg;
            if(!o.host && toolPwr[o.type]) d = 2 + (toolPwr[o.type] * 3) + game.player.skills.har; // D√©gats ressources
            
            o.hp -= d;
            spawnText(Math.floor(d), o.x, o.y, '#fff');
            
            if(o.hp <= 0) {
                kill(o, i);
            }
            hit = true;
        }
    });
}

function kill(o, idx) {
    game.objs.splice(idx, 1);
    let xp = 0;
    let drop = null;
    let n = 1 + Math.floor(game.player.skills.har / 2);

    // Drops
    if(o.type==='tree') { game.inv.wood+=n; checkQuest('wood',n); xp=2; spawnText(`+${n} Bois`, o.x, o.y, '#a65'); }
    if(o.type==='stone') { game.inv.stone+=n; checkQuest('stone',n); xp=3; spawnText(`+${n} Pierre`, o.x, o.y, '#888'); }
    if(o.type==='gold') { game.inv.gold+=n; checkQuest('gold',n); xp=10; spawnText(`+${n} Or`, o.x, o.y, '#fd0'); }
    if(o.type==='iron') { game.inv.iron+=n; checkQuest('iron',n); xp=8; spawnText(`+${n} Fer`, o.x, o.y, '#ccc'); }
    if(o.type==='ruby') { game.inv.ruby+=n; xp=15; spawnText(`+${n} Rubis`, o.x, o.y, '#f00'); }
    if(o.type==='obsidian') { game.inv.obsidian+=n; xp=20; spawnText(`+${n} Obsidienne`, o.x, o.y, '#000'); }
    
    if(o.host) {
        xp = o.xp;
        spawnText(`+${xp} XP`, o.x, o.y, '#0ff');
        if(o.type==='wolf') checkQuest('kill_wolf',1);
        if(o.type==='boss') checkQuest('kill_boss',1);
        if(o.type==='dragon') checkQuest('kill_dragon',1);
    }

    gainXp(xp);
    updateUI();
}

function gainXp(amount) {
    game.player.xp += amount;
    if(game.player.xp >= game.player.nextXp) {
        game.player.xp -= game.player.nextXp;
        game.player.lvl++;
        game.player.sp++;
        game.player.nextXp = Math.floor(game.player.nextXp * 1.2);
        spawnText("NIVEAU UP!", game.player.x, game.player.y - 30, '#f1c40f');
    }
}

/* ==================================================================
   RENDU (DRAW)
   ================================================================== */
function draw() {
    // Fond
    CTX.fillStyle = '#000'; CTX.fillRect(0,0,CANVAS.width,CANVAS.height);
    
    // Optimisation: Dessiner le fond par tiles visible
    let startX = Math.floor(game.cam.x / 2000) * 2000;
    let startY = Math.floor(game.cam.y / 2000) * 2000;
    for(let x=startX; x<game.cam.x+CANVAS.width; x+=2000) {
        for(let y=startY; y<game.cam.y+CANVAS.height; y+=2000) {
            let b = getBiome(x+100, y+100);
            CTX.fillStyle = BIOMES[b].bg;
            CTX.fillRect(x-game.cam.x, y-game.cam.y, 2000, 2000);
        }
    }

    // Objets
    game.objs.forEach(o => {
        if(o.x < game.cam.x - 100 || o.x > game.cam.x + CANVAS.width + 100 || 
           o.y < game.cam.y - 100 || o.y > game.cam.y + CANVAS.height + 100) return;
        
        let asset = PIXELS[o.asset];
        // Fallback color render si asset complexe
        if(!asset && o.color) {
            CTX.fillStyle = o.color;
            CTX.fillRect(o.x - o.w/2 - game.cam.x, o.y - o.h/2 - game.cam.y, o.w, o.h);
        } else if(asset) {
            drawPixel(asset, o.x - game.cam.x, o.y - game.cam.y, 3); // Scale 3
        }

        // Barre de vie
        if(o.hp < o.mHp) {
            CTX.fillStyle = 'black';
            CTX.fillRect(o.x-20 - game.cam.x, o.y-35 - game.cam.y, 40, 5);
            CTX.fillStyle = 'red';
            CTX.fillRect(o.x-20 - game.cam.x, o.y-35 - game.cam.y, 40 * (o.hp/o.mHp), 5);
        }
    });

    // Joueur
    drawPixel(PIXELS.PLAYER, game.player.x - game.cam.x, game.player.y - game.cam.y, 3);

    // Particules
    game.particles.forEach((p, i) => {
        p.life--; p.y--;
        CTX.globalAlpha = p.life/30;
        CTX.fillStyle = p.c;
        CTX.font = "bold 16px Arial";
        CTX.fillText(p.txt, p.x - game.cam.x, p.y - game.cam.y);
        CTX.globalAlpha = 1;
        if(p.life<=0) game.particles.splice(i,1);
    });

    // Minimap
    if(uiState.map) drawMinimap();
}

function drawPixel(data, cx, cy, s) {
    let sz = data.length;
    let off = (sz*s)/2;
    for(let r=0; r<sz; r++) {
        for(let c=0; c<sz; c++) {
            if(data[r][c] !== 0) {
                CTX.fillStyle = PALETTE[data[r][c]];
                CTX.fillRect(cx - off + c*s, cy - off + r*s, s, s);
            }
        }
    }
}

function drawMinimap() {
    const mc = document.getElementById('minimapCanvas').getContext('2d');
    mc.clearRect(0,0,150,150);
    mc.fillStyle = game.player.x < 10000 ? '#555' : '#27ae60'; // Couleur approximative
    mc.fillRect(0,0,150,150);
    // Player dot
    let mx = (game.player.x / W_W) * 150;
    let my = (game.player.y / W_H) * 150;
    mc.fillStyle = 'red'; mc.beginPath(); mc.arc(mx,my,3,0,6.28); mc.fill();
}

/* ==================================================================
   SYSTEMES & UI
   ================================================================== */
game.craft = function(item) {
    let i = game.inv;
    let msg = "Pas assez de ressources";
    let ok = false;

    if(item==='house' && i.wood>=50) { i.wood-=50; createObj('house', game.player.x, game.player.y); game.house=1; ok=true; checkQuest('house',1); }
    if(item==='wall' && i.stone>=10) { i.stone-=10; createObj('wall', game.player.x, game.player.y); ok=true; }
    if(item==='chest' && i.wood>=20 && i.iron>=5) { i.wood-=20; i.iron-=5; createObj('chest', game.player.x, game.player.y); ok=true; }
    
    if(item==='portal' && i.ruby>=50 && !game.portal.built) { 
        i.ruby-=50; 
        game.portal.built = true; 
        game.portal.x = game.player.x; game.portal.y = game.player.y;
        createObj('portal', game.player.x+50, game.player.y); 
        ok=true; checkQuest('portal',1);
    }

    if(item==='axe' && i.wood>=20) { i.wood-=20; i.axe++; ok=true; checkQuest('axe',1); }
    if(item==='pick' && i.wood>=20 && i.stone>=20) { i.wood-=20; i.stone-=20; i.pick++; ok=true; }
    if(item==='sword' && i.wood>=50 && i.gold>=10) { i.wood-=50; i.gold-=10; i.sword++; ok=true; checkQuest('sword',1); }
    if(item==='armor' && i.stone>=50) { i.stone-=50; i.armor++; game.player.maxHp+=50; ok=true; }
    if(item==='boots' && i.wood>=50) { i.wood-=50; i.boots++; ok=true; }

    if(ok) {
        spawnText("Craft OK!", game.player.x, game.player.y, '#fff');
        updateUI();
    } else {
        spawnText(msg, game.player.x, game.player.y, 'red');
    }
};

game.upgradeSkill = function(s) {
    if(game.player.sp > 0) {
        game.player.sp--;
        game.player.skills[s]++;
        if(s==='vit') { game.player.maxHp += 20; game.player.hp += 20; }
        updateUI();
    }
};

function checkQuest(type, n) {
    let q = QUESTS[game.quest.id];
    if(q && q.t === type) {
        game.quest.prog += n;
        if(game.quest.prog >= q.n) {
            game.quest.id++;
            game.quest.prog=0;
            spawnText("QU√äTE R√âUSSIE!", game.player.x, game.player.y-50, 'gold');
        }
        updateUI();
    }
}

function spawnText(txt, x, y, c) {
    game.particles.push({txt:txt, x:x, y:y, c:c, life:60});
}

function updateUI() {
    // Stats
    document.getElementById('hud-hp-text').innerText = Math.floor(game.player.hp) + "/" + game.player.maxHp;
    document.getElementById('hud-hp-bar').style.width = (game.player.hp/game.player.maxHp)*100 + "%";
    document.getElementById('hud-lvl').innerText = game.player.lvl;
    document.getElementById('hud-sp').innerText = game.player.sp;
    document.getElementById('hud-xp-bar').style.width = (game.player.xp/game.player.nextXp)*100 + "%";
    
    // Res
    document.getElementById('res-wood').innerText = game.inv.wood;
    document.getElementById('res-stone').innerText = game.inv.stone;
    document.getElementById('res-gold').innerText = game.inv.gold;
    document.getElementById('res-iron').innerText = game.inv.iron;
    document.getElementById('res-ruby').innerText = game.inv.ruby;
    document.getElementById('res-obsidian').innerText = game.inv.obsidian;

    // Quest
    let q = QUESTS[game.quest.id];
    document.getElementById('quest-txt').innerText = q ? `${q.txt} (${game.quest.prog}/${q.n})` : "VICTOIRE !";
    
    // Craft Costs
    document.getElementById('c-house').innerText = "50 Bois";
    document.getElementById('lvl-sword').innerText = "Niv " + game.inv.sword;
    document.getElementById('c-sword').innerText = "50 Bois + 10 Or";
    // etc... simplified updates

    // Skills
    document.getElementById('skill-points-display').innerText = game.player.sp;
    document.getElementById('s-str').innerText = game.player.skills.str;
    document.getElementById('s-spd').innerText = game.player.skills.spd;
    document.getElementById('s-har').innerText = game.player.skills.har;
    document.getElementById('s-vit').innerText = game.player.skills.vit;
}

function toggleUI(menu) {
    // Close others
    document.getElementById('craft-menu').style.display = 'none';
    document.getElementById('skills-menu').style.display = 'none';
    document.getElementById('controls-menu').style.display = 'none';
    
    if(menu === 'craft') {
        uiState.craft = !uiState.craft;
        if(uiState.craft) document.getElementById('craft-menu').style.display = 'block';
    }
    if(menu === 'skills') {
        uiState.skills = !uiState.skills;
        if(uiState.skills) document.getElementById('skills-menu').style.display = 'block';
    }
    if(menu === 'controls') {
        uiState.controls = !uiState.controls;
        if(uiState.controls) document.getElementById('controls-menu').style.display = 'block';
    }
}

function endGame() {
    isRunning = false;
    document.getElementById('death-screen').style.display = 'block';
    if(game.house) document.getElementById('btn-respawn').style.display = 'inline-block';
}

function respawn() {
    game.player.x = game.portal.built ? game.portal.x : 15000; 
    game.player.y = game.portal.built ? game.portal.y : 15000;
    // Si maison existe, on cherche ses coords (simplifi√© ici)
    let h = game.objs.find(o => o.type==='house');
    if(h) { game.player.x = h.x; game.player.y = h.y; }
    
    game.player.hp = game.player.maxHp;
    document.getElementById('death-screen').style.display = 'none';
    isRunning = true;
    loop(performance.now());
}

/* ==================================================================
   EVENTS
   ================================================================== */
function setupEvents() {
    window.addEventListener('resize', () => { CANVAS.width = window.innerWidth; CANVAS.height = window.innerHeight; });
    window.addEventListener('keydown', e => {
        if(e.key === 'z' || e.key === 'w') keys['z'] = true;
        if(e.key === 's') keys['s'] = true;
        if(e.key === 'q' || e.key === 'a') keys['q'] = true;
        if(e.key === 'd') keys['d'] = true;
        
        if(e.key === 'Tab') { e.preventDefault(); toggleUI('craft'); }
        if(e.key === 'c' || e.key === 'C') { e.preventDefault(); toggleUI('skills'); }
        if(e.key === 'CapsLock') { e.preventDefault(); uiState.map = !uiState.map; document.getElementById('minimap-container').style.display = uiState.map ? 'block' : 'none'; }
        if(e.key === '¬≤') toggleUI('controls');
    });
    window.addEventListener('keyup', e => {
        if(e.key === 'z' || e.key === 'w') keys['z'] = false;
        if(e.key === 's') keys['s'] = false;
        if(e.key === 'q' || e.key === 'a') keys['q'] = false;
        if(e.key === 'd') keys['d'] = false;
    });
    CANVAS.addEventListener('mousedown', () => action());
}

// Start
init();

</script>
</body>
</html>
