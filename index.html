<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Survival RPG ULTIMATE - 10k Map</title>
<style>
    /* --- CSS GLOBAL --- */
    * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', sans-serif; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; }
    
    #gameCanvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; cursor: crosshair; }

    /* --- UI --- */
    .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    
    .hud { position: absolute; top: 10px; left: 10px; background: rgba(20,20,20,0.9); color: #fff; padding: 8px; border-radius: 8px; border: 2px solid #555; font-size: 13px; font-weight: bold; display: flex; flex-direction: column; gap: 5px; pointer-events: auto; max-width: 200px; }
    .hud-row { display: flex; justify-content: space-between; gap: 10px; }

    .top-right-ui { position: absolute; top: 10px; right: 10px; display: flex; align-items: flex-end; gap: 10px; flex-direction: column; pointer-events: none; }
    
    .quest-box { background: rgba(0,0,0,0.6); color: #f1c40f; padding: 10px; border-radius: 5px; border-left: 4px solid #f1c40f; font-size: 14px; max-width: 250px; text-align: right; pointer-events: none; margin-top: 10px; }
    .quest-title { font-weight: 900; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; color: #aaa; }
    
    .pc-controls-hint {
        position: absolute; bottom: 10px; right: 10px;
        color: rgba(255,255,255,0.5); font-size: 12px; text-align: right;
        pointer-events: none;
    }

    /* MINIMAP */
    #minimap-container {
        position: absolute; top: 10px; right: 10px;
        border: 3px solid #fff; border-radius: 4px;
        background: #000; display: none; /* Cach√© par d√©faut */
        pointer-events: auto;
        z-index: 100;
    }
    #minimapCanvas { display: block; background: #000; }

    /* MENUS & MODALS */
    .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2c3e50; width: 80%; max-width: 600px; border: 4px solid #fff; border-radius: 15px; display: none; z-index: 5000; padding: 20px; color: #fff; pointer-events: auto; box-shadow: 0 0 50px #000; overflow-y: auto; text-align: center; }
    .modal h2 { color: #f1c40f; margin-top: 0; border-bottom: 1px solid #555; padding-bottom: 10px; }
    
    .craft-row { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 10px; margin-bottom: 8px; border-radius: 5px; border: 1px solid #444; }
    .btn { background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: bold; border-bottom: 3px solid #1e8449; cursor: pointer; }
    .btn:active { border-bottom: 0; transform: translateY(3px); }
    .btn:hover { background: #2ecc71; } 
    .btn:disabled { background: #7f8c8d; border-bottom: 3px solid #555; opacity: 0.5; }
    
    /* ECRAN MORT */
    #death-screen { background: rgba(192, 57, 43, 0.95); border-color: #e74c3c; width: 90%; max-width: 400px; }
    .death-options { display: flex; flex-direction: column; gap: 10px; align-items: center; }
    .death-options button { width: 100%; font-size: 16px; padding: 12px; }
    #btn-respawn { background: #3498db; border-bottom-color: #2980b9; display: none; }

</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<div id="night-overlay" style="position:absolute;top:0;left:0;width:100%;height:100%;background:black;pointer-events:none;opacity:0;z-index:10;"></div>

<div class="ui-layer">
    <div class="hud">
        <div class="hud-row" style="color:#e74c3c; border-bottom:1px solid #444; padding-bottom:5px; margin-bottom:5px;">
            <span>‚ù§Ô∏è VIE</span> <span id="hud-hp">100/100</span>
        </div>
        <div class="hud-row"><span>ü™µ Bois</span> <span id="hud-wood">0</span></div>
        <div class="hud-row"><span>ü™® Pierre</span> <span id="hud-stone">0</span></div>
        <div class="hud-row"><span>üü° Or</span> <span id="hud-gold">0</span></div>
        <div class="hud-row"><span>‚ö™ Fer</span> <span id="hud-iron">0</span></div>
        <div class="hud-row"><span>‚ö´ Obsi</span> <span id="hud-obsi">0</span></div>
        <div class="hud-row" style="margin-top:5px; color:#aaa; font-size:10px;">Biomes: For√™t, D√©sert, Neige, Volcan</div>
    </div>
    
    <div id="minimap-container">
        <canvas id="minimapCanvas" width="200" height="200"></canvas>
        <div style="color:white; font-size:10px; text-align:center; background:#222; padding:2px;">CARTE (VerrMaj)</div>
    </div>

    <div class="top-right-ui">
        <div class="quest-box">
            <div class="quest-title">OBJECTIF ACTUEL</div>
            <div id="quest-txt">Chargement...</div>
        </div>
    </div>
    
    <div class="pc-controls-hint">
        <b>[ZQSD]</b> Bouger &nbsp; <b>[CLIC GAUCHE]</b> Action &nbsp; <b>[TAB]</b> Menu &nbsp; <b>[VERR MAJ]</b> Carte
    </div>
</div>

<div id="craft-menu" class="modal">
    <h2>üõ†Ô∏è FORGE & ARTISANAT</h2>
    <div class="craft-row" style="border-color:#f39c12; background:rgba(243,156,18,0.1);">
        <div><strong>üè† BASE / SOIN (Niv <span id="house-lvl">0</span>)</strong><br><small id="house-desc">Permet de Respawn + Soin</small><br><span class="cost" id="house-cost">...</span></div>
        <button class="btn" id="btn-house" onclick="game.craft('house')">B√ÇTIR</button>
    </div>
    <div class="craft-row" style="border-color:#3498db; background:rgba(52,152,219,0.1);">
        <div><strong>üõ°Ô∏è ARMURE (Niv <span id="armor-lvl">0</span>)</strong><br><small>+PV Max (Base requise)</small><br><span class="cost" id="armor-cost">...</span></div>
        <button class="btn" id="btn-armor" onclick="game.craft('armor')">FORGER</button>
    </div>
    <h3>OUTILS</h3>
    <div class="craft-row"><div>ü™ì <strong>HACHE</strong> <small id="axe-lvl-menu">Niv 1</small><br><span class="cost" id="axe-cost">...</span></div><button class="btn" id="btn-axe" onclick="game.craft('axe')">UP</button></div>
    <div class="craft-row"><div>‚õèÔ∏è <strong>PIOCHE</strong> <small id="pick-lvl-menu">Niv 1</small><br><span class="cost" id="pick-cost">...</span></div><button class="btn" id="btn-pick" onclick="game.craft('pick')">UP</button></div>
    <div class="craft-row"><div>‚öîÔ∏è <strong>√âP√âE</strong> <small id="sword-lvl-menu">Niv 1</small><br><span class="cost" id="sword-cost">...</span></div><button class="btn" id="btn-sword" onclick="game.craft('sword')">UP</button></div>

    <button class="btn close-modal" onclick="toggleMenu(false)">RETOUR JEU (TAB)</button>
</div>

<div id="death-screen" class="modal">
    <h2>üíÄ MORT !</h2>
    <p>Ton aventure s'arr√™te ici... ou pas ?</p>
    <div class="death-options">
        <button class="btn" id="btn-respawn" onclick="respawnBase()">üè† RESPAWN BASE</button>
        <button class="btn" id="btn-restart" style="background:#c0392b;" onclick="location.reload()">‚ò†Ô∏è TOUT RECOMMENCER</button>
    </div>
</div>

<script>
/**
 * SURVIVAL RPG ULTIMATE - 10k MAP + BIOMES RANDOM + MINIMAP
 */

const WORLD_W = 10000;
const WORLD_H = 10000;
const CHUNK_SIZE = 1000; // Taille d'un biome (carr√©)
const SCALE_BASE = 4;

const PALETTE = [
    'rgba(0,0,0,0)', '#000000', '#FFFFFF', '#8b4513', '#2ecc71', 
    '#95a5a6', '#e74c3c', '#f1c40f', '#3498db', '#e91e63', 
    '#bdc3c7', '#1c2833', '#1e8449'
];

// Configuration des Biomes
const BIOME_TYPES = {
    FOREST: { color: '#27ae60', ground: '#2ecc71', tree: 'TREE', rock: 'STONE', mob: null, rare: null },
    DESERT: { color: '#e67e22', ground: '#f1c40f', tree: null, rock: 'ROCK_GOLD', mob: 'SCORPION', rare: 'gold_rock' },
    SNOW:   { color: '#bdc3c7', ground: '#ecf0f1', tree: null, rock: 'IRON_ROCK', mob: 'WOLF', rare: 'iron_rock' },
    VOLCANO:{ color: '#c0392b', ground: '#581212', tree: null, rock: 'RUBY', mob: 'DEMON', rare: 'ruby' }
};

const PIXEL_ASSETS = {
    PLAYER_IDLE: [[0,0,1,1,1,1,0,0],[0,1,6,2,2,6,1,0],[0,1,6,2,2,6,1,0],[0,0,1,3,3,1,0,0],[0,0,1,3,3,1,0,0],[0,0,1,2,2,1,0,0],[0,0,1,3,3,1,0,0],[0,1,3,0,0,3,1,0]],
    PLAYER_SWORD:[[1,0,0,0,0,0,0,0],[1,1,0,0,0,0,0,0],[0,1,1,0,0,0,0,0],[0,0,1,1,1,1,1,0],[0,0,1,3,3,1,0,0],[0,0,1,2,2,1,0,0],[0,0,1,3,3,1,0,0],[0,1,3,0,0,3,1,0]],
    TREE:        [[0,0,4,4,4,4,0,0],[0,4,4,4,4,4,4,0],[4,4,4,4,4,4,4,4],[0,0,0,3,3,0,0,0],[0,0,0,3,3,0,0,0],[0,0,0,3,3,0,0,0],[0,0,0,3,3,0,0,0],[0,0,0,3,3,0,0,0]],
    STONE:       [[0,0,5,5,5,5,0,0],[0,5,5,5,5,5,5,0],[5,5,5,1,5,5,5,5],[5,5,1,5,5,5,5,5],[0,5,5,5,5,5,5,0],[0,0,5,5,5,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],
    SLIME:       [[0,0,4,4,4,4,0,0],[0,4,4,4,4,4,4,0],[4,4,4,4,4,4,4,4],[4,4,1,4,4,1,4,4],[4,4,4,4,4,4,4,4],[0,4,4,1,1,4,4,0],[0,0,4,4,4,4,0,0],[0,0,0,0,0,0,0,0]],
    HOUSE_LVL1:  [[0,0,0,1,1,0,0,0],[0,0,1,6,6,1,0,0],[0,1,3,3,3,3,1,0],[1,3,3,3,3,3,3,1],[1,3,2,1,1,2,3,1],[1,3,2,1,1,2,3,1],[1,3,3,3,3,3,3,1],[1,1,1,1,1,1,1,1]],
    HOUSE_LVL2:  [[0,0,1,2,2,1,0,0],[0,1,3,3,3,3,1,0],[1,3,7,7,7,7,3,1],[1,3,7,2,2,7,3,1],[1,3,7,2,2,7,3,1],[1,3,7,7,7,7,3,1],[1,3,3,3,3,3,3,1],[1,1,1,1,1,1,1,1]],
    ROCK_GOLD:   [[0,7,7,7,7,0,0,0],[7,7,5,5,5,7,7,0],[7,5,5,7,5,5,7,7],[5,7,5,5,5,5,7,0],[5,5,7,7,5,5,0,0],[0,5,5,5,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],
    SCORPION:    [[1,0,0,0,0,0,0,1],[0,1,0,0,0,0,1,0],[0,0,1,1,1,1,0,0],[0,0,1,6,6,1,0,0],[0,0,1,1,1,1,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],
    IRON_ROCK:   [[0,0,10,10,10,10,0,0],[0,10,5,5,5,10,10,0],[10,5,5,10,5,5,10,10],[5,10,5,5,5,5,10,0],[5,5,10,10,5,5,0,0],[0,5,5,5,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],
    WOLF:        [[0,1,1,0,0,1,1,0],[1,2,2,1,1,2,2,1],[1,2,2,2,2,2,2,1],[0,1,2,2,2,2,1,0],[0,0,1,2,2,1,0,0],[0,0,1,1,1,1,0,0],[0,0,1,0,0,1,0,0],[0,0,1,0,0,1,0,0]],
    RUBY:        [[0,0,0,9,9,0,0,0],[0,0,9,9,9,9,0,0],[0,9,9,1,1,9,9,0],[9,9,1,9,9,1,9,9],[9,1,9,9,9,9,1,9],[9,9,9,1,1,9,9,9],[0,9,9,9,9,9,9,0],[0,0,0,0,0,0,0,0]],
    DEMON:       [[0,6,0,1,1,0,6,0],[1,6,1,6,6,1,6,1],[1,1,1,6,6,1,1,1],[0,1,1,6,6,1,1,0],[0,0,1,6,6,1,0,0],[0,0,1,3,3,1,0,0],[0,0,1,3,3,1,0,0],[0,0,1,0,0,1,0,0]],
    BOSS:        [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0],[0,0,0,0,1,6,6,6,6,1,0,0,0,0,0,0],[0,0,0,1,6,6,1,6,6,6,1,0,0,0,0,0],[0,0,1,6,6,6,6,6,6,6,6,1,0,0,0,0],[0,1,6,6,6,6,6,6,6,6,6,6,1,0,0,0],[1,6,6,6,1,1,6,6,1,1,6,6,6,1,0,0],[1,6,6,6,6,6,6,6,6,6,6,6,6,1,0,0],[1,6,6,6,6,6,6,6,6,6,6,6,6,1,0,0],[0,1,6,6,6,1,1,1,1,1,6,6,6,1,0,0],[0,0,1,6,6,1,0,0,0,1,6,6,1,0,0,0],[0,0,0,1,6,1,0,0,0,1,6,1,0,0,0,0],[0,0,0,1,6,1,0,0,0,1,6,1,0,0,0,0],[0,0,0,1,1,1,0,0,0,1,1,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]
};

const QUESTS = [ 
    { id: 0, txt: "R√©colter 10 BOIS", type: 'wood', target: 10 },
    { id: 1, txt: "Fabriquer une MAISON", type: 'house', target: 1 },
    { id: 2, txt: "R√©colter 10 PIERRES", type: 'stone', target: 10 },
    { id: 3, txt: "Am√©liorer la HACHE (Niv 2)", type: 'axe', target: 2 },
    { id: 4, txt: "Trouver un D√âSERT (Scorpions)", type: 'explore_desert', target: 1 },
    { id: 5, txt: "Trouver 5 OR (D√©sert)", type: 'gold', target: 5 },
    { id: 6, txt: "Fabriquer √âP√âE OR (Niv 3)", type: 'sword', target: 3 },
    { id: 7, txt: "Trouver la NEIGE", type: 'explore_snow', target: 1 },
    { id: 8, txt: "Tuer 3 LOUPS", type: 'kill_wolf', target: 3 },
    { id: 9, txt: "Trouver 5 FER (Neige)", type: 'iron', target: 5 },
    { id: 10, txt: "Trouver le VOLCAN", type: 'explore_volcano', target: 1 },
    { id: 11, txt: "Tuer le ROI D√âMON", type: 'kill_boss', target: 1 },
    { id: 12, txt: "VOUS √äTES LE MA√éTRE !", type: 'win', target: 0 }
]; 

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
const minimapCanvas = document.getElementById('minimapCanvas');
const ctxMini = minimapCanvas.getContext('2d');

let isGameRunning = true;
let lastTime = 0;
let keys = {}; 
let isMenuOpen = false;
let isMinimapOpen = false;

// Grille des biomes (ex: mapGrid[y][x] = 'FOREST')
let mapGrid = []; 

let game = { 
    player: { x: 500, y: 500, hp: 100, maxHp: 100, speed: 6, size: 24, angle: 0, iframes: 0 }, 
    inv: { wood:0, stone:0, gold:0, iron:0, obsi:0, axe:1, pick:1, sword:1, armor:0 }, 
    house: { active: false, x: 0, y: 0, lvl: 0, cooldown: 0 }, 
    quest: { id: 0, progress: 0 }, 
    dayTime: 0, 
    camera: { x:0, y:0 }, 
    objects: [], 
    particles: [] 
};

// --- GENERATION MONDE ALEATOIRE ---
function init() {
    resize();
    generateBiomes();
    generateObjects();
    setupInputs();
    requestAnimationFrame(loop);
}

function generateBiomes() {
    const rows = Math.ceil(WORLD_H / CHUNK_SIZE);
    const cols = Math.ceil(WORLD_W / CHUNK_SIZE);
    mapGrid = [];

    for(let y=0; y<rows; y++) {
        let row = [];
        for(let x=0; x<cols; x++) {
            // Le spawn (0,0) est forc√© en FOREST
            if (x===0 && y===0) {
                row.push('FOREST');
                continue;
            }
            // Choix al√©atoire
            const r = Math.random();
            if(r < 0.4) row.push('FOREST');
            else if(r < 0.65) row.push('DESERT');
            else if(r < 0.85) row.push('SNOW');
            else row.push('VOLCANO');
        }
        mapGrid.push(row);
    }
}

function getBiomeAt(x, y) {
    let col = Math.floor(x / CHUNK_SIZE);
    let row = Math.floor(y / CHUNK_SIZE);
    if(row < 0 || row >= mapGrid.length || col < 0 || col >= mapGrid[0].length) return 'FOREST'; // Bordure
    return mapGrid[row][col];
}

function generateObjects() {
    game.objects = [];

    // Fonction pour trouver un point al√©atoire dans un biome sp√©cifique
    const getRandomSpotInBiome = (targetBiome) => {
        for(let i=0; i<50; i++) { // 50 tentatives
            let x = Math.random() * WORLD_W;
            let y = Math.random() * WORLD_H;
            if(getBiomeAt(x, y) === targetBiome) return {x, y};
        }
        return null; // Pas trouv√©
    };

    // 1. Ressources de base (partout sauf si logique sp√©ciale)
    for(let i=0; i<800; i++) {
        let x = Math.random() * WORLD_W;
        let y = Math.random() * WORLD_H;
        let b = getBiomeAt(x, y);
        if(b === 'FOREST') createObject('tree', x, y);
        else if(Math.random() < 0.3) createObject('stone', x, y); // Pierre possible partout mais moins
    }

    // 2. Ressources Sp√©cifiques aux biomes
    for(let i=0; i<300; i++) {
        let x = Math.random() * WORLD_W;
        let y = Math.random() * WORLD_H;
        let b = getBiomeAt(x, y);
        if(b === 'DESERT') createObject('gold_rock', x, y);
        if(b === 'SNOW') createObject('iron_rock', x, y);
        if(b === 'VOLCANO') createObject('ruby', x, y);
    }

    // 3. Mobs (PAS DANS LA FORET)
    const spawnMob = (type, count) => {
        let spawned = 0;
        while(spawned < count) {
            let x = Math.random() * WORLD_W;
            let y = Math.random() * WORLD_H;
            let b = getBiomeAt(x, y);
            
            let valid = false;
            if(type === 'slime' && b !== 'FOREST') valid = true; // Slime partout sauf foret
            if(type === 'scorpion' && b === 'DESERT') valid = true;
            if(type === 'wolf' && b === 'SNOW') valid = true;
            if(type === 'demon' && b === 'VOLCANO') valid = true;

            if(valid) { createObject(type, x, y); spawned++; }
        }
    };

    spawnMob('slime', 50);
    spawnMob('scorpion', 60);
    spawnMob('wolf', 60);
    spawnMob('demon', 40);

    // Boss (Volcan lointain)
    let bossSpot = getRandomSpotInBiome('VOLCANO');
    if(!bossSpot) bossSpot = {x: 9500, y: 9500};
    createObject('boss', bossSpot.x, bossSpot.y);
    for(let a=0; a<Math.PI*2; a+=0.5) createObject('wall', bossSpot.x+Math.cos(a)*400, bossSpot.y+Math.sin(a)*400);
}

function createObject(type, x, y) {
    let o = { type, x, y, hp:1, maxHp:1, size:40, asset:'STONE', solid:false, hostile:false, speed: 0, dmg: 0 };
    
    if(type==='tree') { o.asset='TREE'; o.hp=15; o.maxHp=15; o.size=50; }
    if(type==='stone') { o.asset='STONE'; o.hp=25; o.maxHp=25; o.size=40; }
    if(type==='gold_rock') { o.asset='ROCK_GOLD'; o.hp=40; o.maxHp=40; o.size=35; }
    if(type==='iron_rock') { o.asset='IRON_ROCK'; o.hp=50; o.maxHp=50; o.size=35; }
    if(type==='ruby') { o.asset='RUBY'; o.hp=60; o.maxHp=60; o.size=30; }
    
    if(type==='slime') { o.asset='SLIME'; o.hp=30; o.maxHp=30; o.hostile=true; o.speed=2; o.dmg=5; o.size=30; }
    if(type==='scorpion') { o.asset='SCORPION'; o.hp=60; o.maxHp=60; o.hostile=true; o.speed=4; o.dmg=10; o.size=25; }
    if(type==='wolf') { o.asset='WOLF'; o.hp=100; o.maxHp=100; o.hostile=true; o.speed=5; o.dmg=15; o.size=35; }
    if(type==='demon') { o.asset='DEMON'; o.hp=150; o.maxHp=150; o.hostile=true; o.speed=3.5; o.dmg=25; o.size=35; }
    if(type==='boss') { o.asset='BOSS'; o.hp=1000; o.maxHp=1000; o.hostile=true; o.speed=4.5; o.dmg=40; o.size=80; o.isBoss=true; }
    if(type==='wall') { o.asset='STONE'; o.hp=9999; o.solid=true; o.size=40; }
    
    game.objects.push(o);
}

// --- GAME LOOP & UPDATE ---
function loop(time) {
    if(!isGameRunning) return;
    let dt = time - lastTime; lastTime = time;
    update(dt);
    draw();
    if(isMinimapOpen) drawMinimap();
    updateUI();
    if(game.player.hp <= 0) { showDeathScreen(); return; }
    requestAnimationFrame(loop);
}

function update(dt) {
    // Mouvement ZQSD
    let dx = 0, dy = 0;
    if (keys['KeyW'] || keys['KeyZ'] || keys['ArrowUp']) dy = -1;
    if (keys['KeyS'] || keys['ArrowDown']) dy = 1;
    if (keys['KeyA'] || keys['KeyQ'] || keys['ArrowLeft']) dx = -1;
    if (keys['KeyD'] || keys['ArrowRight']) dx = 1;

    if (dx !== 0 || dy !== 0) {
        let length = Math.sqrt(dx*dx + dy*dy);
        dx /= length; dy /= length;
        game.player.angle = Math.atan2(dy, dx);
        let nx = game.player.x + dx * game.player.speed;
        let ny = game.player.y + dy * game.player.speed;
        nx = Math.max(0, Math.min(WORLD_W, nx));
        ny = Math.max(0, Math.min(WORLD_H, ny));

        let collide = game.objects.some(o => o.solid && Math.hypot(nx-o.x, ny-o.y) < game.player.size + o.size/2);
        if(!collide) { game.player.x = nx; game.player.y = ny; }
    }

    // Quests Explo
    let currentBiome = getBiomeAt(game.player.x, game.player.y);
    if(currentBiome === 'DESERT') checkQuest('explore_desert', 1);
    if(currentBiome === 'SNOW') checkQuest('explore_snow', 1);
    if(currentBiome === 'VOLCANO') checkQuest('explore_volcano', 1);

    // Camera
    game.camera.x = game.player.x - canvas.width/2;
    game.camera.y = game.player.y - canvas.height/2;

    // Mobs Logic
    if(game.player.iframes > 0) game.player.iframes--;
    game.objects.forEach(o => {
        if(o.hostile && o.hp > 0) {
            let dist = Math.hypot(game.player.x - o.x, game.player.y - o.y);
            if(dist < 400) { // Aggro range
                o.x += (game.player.x - o.x) / dist * o.speed;
                o.y += (game.player.y - o.y) / dist * o.speed;
                if(dist < game.player.size + o.size/2 && game.player.iframes <= 0) {
                    game.player.hp -= o.dmg;
                    game.player.iframes = 40;
                    createFloatText(`-${o.dmg}`, game.player.x, game.player.y, 'red');
                }
            }
        }
    });

    // House Heal
    if(game.house.active) {
        let dist = Math.hypot(game.player.x - game.house.x, game.player.y - game.house.y);
        if(dist < 150) {
            game.house.cooldown++;
            if(game.house.cooldown > 30 && game.player.hp < game.player.maxHp) {
                game.player.hp += 2; game.house.cooldown = 0;
                createFloatText("üíö", game.player.x, game.player.y-30, '#2ecc71');
            }
        }
    }

    // Jour/Nuit
    game.dayTime += 0.0003; // Plus lent sur grande map
    if(game.dayTime > 1) game.dayTime = 0;
}

// --- RENDU ---
function drawPixelArt(assetName, x, y, scale = SCALE_BASE) {
    const asset = PIXEL_ASSETS[assetName];
    if (!asset) return; 
    const size = asset.length;
    const halfSize = (size * scale) / 2;
    ctx.save(); ctx.translate(x - halfSize, y - halfSize);
    for (let r = 0; r < size; r++) {
        for (let c = 0; c < size; c++) {
            const ci = asset[r][c];
            if (ci !== 0) { ctx.fillStyle = PALETTE[ci]; ctx.fillRect(c * scale, r * scale, scale, scale); }
        }
    }
    ctx.restore();
}

function draw() {
    // 1. Background Grid (Optimis√©: dessine seulement les chunks visibles)
    ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
    
    ctx.save();
    ctx.translate(-game.camera.x, -game.camera.y);

    let startCol = Math.floor(game.camera.x / CHUNK_SIZE);
    let endCol = startCol + Math.ceil(canvas.width / CHUNK_SIZE) + 1;
    let startRow = Math.floor(game.camera.y / CHUNK_SIZE);
    let endRow = startRow + Math.ceil(canvas.height / CHUNK_SIZE) + 1;

    for(let r = startRow; r < endRow; r++) {
        for(let c = startCol; c < endCol; c++) {
            if(r >= 0 && r < mapGrid.length && c >= 0 && c < mapGrid[0].length) {
                let type = mapGrid[r][c];
                ctx.fillStyle = BIOME_TYPES[type].ground;
                ctx.fillRect(c*CHUNK_SIZE, r*CHUNK_SIZE, CHUNK_SIZE, CHUNK_SIZE);
            }
        }
    }

    // 2. Objects
    game.objects.sort((a,b) => a.y - b.y);
    for(let o of game.objects) {
        if(o.x + o.size < game.camera.x || o.x - o.size > game.camera.x + canvas.width || 
           o.y + o.size < game.camera.y || o.y - o.size > game.camera.y + canvas.height) continue;
        
        let scale = o.isBoss ? SCALE_BASE * 3 : SCALE_BASE;
        drawPixelArt(o.asset, o.x, o.y, scale);
        
        if(o.hp < o.maxHp || o.isBoss) {
            let w = 40; if(o.isBoss) w=100;
            let pct = o.hp / o.maxHp;
            ctx.fillStyle = 'black'; ctx.fillRect(o.x-w/2, o.y-o.size, w, 6);
            ctx.fillStyle = 'red'; ctx.fillRect(o.x-w/2, o.y-o.size, w*pct, 6);
        }
    }

    // 3. House
    if(game.house.active) {
        let hAsset = (game.house.lvl == 1) ? 'HOUSE_LVL1' : 'HOUSE_LVL2';
        drawPixelArt(hAsset, game.house.x, game.house.y, SCALE_BASE * 2);
    }

    // 4. Player
    if(game.player.iframes % 4 < 2) {
        let pAsset = (game.inv.sword > 1) ? 'PLAYER_SWORD' : 'PLAYER_IDLE';
        drawPixelArt(pAsset, game.player.x, game.player.y, SCALE_BASE * 1.5);
    }
    
    // 5. Nuit
    let darkness = 0;
    if(game.dayTime > 0.7 || game.dayTime < 0.2) darkness = 0.6; 
    document.getElementById('night-overlay').style.opacity = darkness;

    // 6. Particules
    for(let i=game.particles.length-1; i>=0; i--) {
        let p = game.particles[i];
        p.y -= 1; p.life--;
        ctx.globalAlpha = p.life/40;
        ctx.font = "bold 20px Arial";
        ctx.fillStyle = p.col;
        ctx.fillText(p.txt, p.x, p.y);
        if(p.life <= 0) game.particles.splice(i, 1);
    }
    ctx.globalAlpha = 1;
    ctx.restore();
}

function drawMinimap() {
    // Dessine la carte enti√®re sur un petit canvas
    const scaleX = minimapCanvas.width / WORLD_W;
    const scaleY = minimapCanvas.height / WORLD_H;
    
    ctxMini.clearRect(0, 0, minimapCanvas.width, minimapCanvas.height);

    // Fond des biomes
    for(let r=0; r<mapGrid.length; r++) {
        for(let c=0; c<mapGrid[r].length; c++) {
            ctxMini.fillStyle = BIOME_TYPES[mapGrid[r][c]].color;
            ctxMini.fillRect(c*CHUNK_SIZE*scaleX, r*CHUNK_SIZE*scaleY, CHUNK_SIZE*scaleX, CHUNK_SIZE*scaleY);
        }
    }

    // Maison
    if(game.house.active) {
        ctxMini.fillStyle = '#00FF00';
        ctxMini.fillRect(game.house.x*scaleX - 2, game.house.y*scaleY - 2, 4, 4);
    }

    // Joueur
    ctxMini.fillStyle = 'red';
    ctxMini.beginPath();
    ctxMini.arc(game.player.x*scaleX, game.player.y*scaleY, 3, 0, Math.PI*2);
    ctxMini.fill();
}

// --- LOGIQUE JEU ---
function handleAction() {
    let t = getNearestTarget();
    if(!t) return;

    let dmg = 1;
    if(t.hostile) dmg = game.inv.sword * 6;
    else if(t.type === 'tree') dmg = game.inv.axe * 3;
    else dmg = game.inv.pick * 3;

    t.hp -= dmg;
    createFloatText("üí•", t.x, t.y, '#fff');

    if(t.hp <= 0) {
        if(t.type === 'tree') { game.inv.wood += 5; checkQuest('wood', 5); createFloatText("+5 BOIS", t.x, t.y, '#2ecc71'); }
        if(t.type === 'stone') { game.inv.stone += 3; checkQuest('stone', 3); createFloatText("+3 PIERRE", t.x, t.y, '#95a5a6'); }
        if(t.type === 'gold_rock') { game.inv.gold += 2; checkQuest('gold', 2); createFloatText("+2 OR", t.x, t.y, 'gold'); }
        if(t.type === 'iron_rock') { game.inv.iron += 2; checkQuest('iron', 2); createFloatText("+2 FER", t.x, t.y, '#fff'); }
        if(t.type === 'ruby') { game.inv.ruby += 1; createFloatText("+1 RUBIS", t.x, t.y, '#e91e63'); }
        
        if(t.type === 'wolf') checkQuest('kill_wolf', 1);
        if(t.type === 'boss') checkQuest('kill_boss', 1);

        game.objects.splice(game.objects.indexOf(t), 1);
    }
}

function getNearestTarget() {
    let closest = null, minDist = 150;
    for(let o of game.objects) {
        if(o.type === 'wall') continue;
        let d = Math.hypot(game.player.x - o.x, game.player.y - o.y);
        if(d < minDist) { minDist = d; closest = o; }
    }
    return closest;
}

function checkQuest(type, amount) {
    let q = QUESTS[game.quest.id];
    if(!q) return; 
    if(q.type === type) {
        game.quest.progress += amount;
        if(game.quest.progress >= q.target) {
            createFloatText("üèÜ QU√äTE FINIE !", game.player.x, game.player.y - 50, 'gold');
            game.quest.id++;
            game.quest.progress = 0;
        }
    }
}

game.craft = function(item) {
    let msg = "";
    if(item === 'house') {
        let costs = [{w:50},{w:150},{w:300}];
        if(game.house.lvl >= 3) return;
        let c = costs[game.house.lvl];
        if(game.inv.wood >= c.w) {
            game.inv.wood -= c.w;
            if(game.house.lvl === 0) { game.house.active = true; game.house.x = game.player.x; game.house.y = game.player.y; checkQuest('house', 1); }
            game.house.lvl++; msg = "BASE UP!";
        }
    }
    // Reste du craft identique...
    if(item === 'armor' && game.house.active) {
         let costs = [{s:50,w:50},{s:100,i:10},{s:200,ob:5}];
         if(game.inv.armor < 3) {
             let c = costs[game.inv.armor];
             let ok=false;
             if(game.inv.armor==0 && game.inv.stone>=c.s && game.inv.wood>=c.w) {game.inv.stone-=c.s; game.inv.wood-=c.w; ok=true;}
             if(game.inv.armor==1 && game.inv.stone>=c.s && game.inv.iron>=c.i) {game.inv.stone-=c.s; game.inv.iron-=c.i; ok=true;}
             if(game.inv.armor==2 && game.inv.stone>=c.s && game.inv.obsi>=c.ob) {game.inv.stone-=c.s; game.inv.obsi-=c.ob; ok=true;}
             if(ok) { game.inv.armor++; game.player.maxHp+=100; game.player.hp=game.player.maxHp; msg="ARMURE UP!"; }
         }
    }
    if(item === 'axe' && game.inv.wood >= game.inv.axe*20) { game.inv.wood -= game.inv.axe*20; game.inv.axe++; checkQuest('axe', 1); msg="HACHE UP !"; }
    if(item === 'pick' && game.inv.wood >= 20 && game.inv.stone >= 20) { game.inv.wood-=20; game.inv.stone-=20; game.inv.pick++; msg="PIOCHE UP !"; }
    if(item === 'sword' && game.inv.wood >= 50 && game.inv.gold >= game.inv.sword*5) { game.inv.wood-=50; game.inv.gold-=game.inv.sword*5; game.inv.sword++; checkQuest('sword', 1); msg="√âP√âE UP !"; }

    if(msg) { createFloatText(msg, game.player.x, game.player.y, '#fff'); updateUI(); }
};

// --- UI & RESPAWN ---
function updateUI() {
    document.getElementById('hud-hp').innerText = Math.floor(game.player.hp) + "/" + game.player.maxHp;
    document.getElementById('hud-wood').innerText = game.inv.wood;
    document.getElementById('hud-stone').innerText = game.inv.stone;
    document.getElementById('hud-gold').innerText = game.inv.gold;
    document.getElementById('hud-iron').innerText = game.inv.iron;
    document.getElementById('hud-obsi').innerText = game.inv.obsi;

    let q = QUESTS[game.quest.id];
    document.getElementById('quest-txt').innerText = q ? `${q.txt} (${game.quest.progress}/${q.target})` : "Gagn√© !";

    // Menu cost updates (simplifi√© pour lisibilit√©)
    document.getElementById('house-cost').innerText = (game.house.lvl<3) ? ["50 B", "150 B", "300 B"][game.house.lvl] : "MAX";
    document.getElementById('house-lvl').innerText = game.house.lvl;
}

function createFloatText(txt, x, y, col) { game.particles.push({txt, x, y, col, life:40}); }

function showDeathScreen() {
    isGameRunning = false;
    document.getElementById('death-screen').style.display = 'block';
    // Affiche le bouton respawn seulement si la maison est construite
    document.getElementById('btn-respawn').style.display = game.house.active ? 'block' : 'none';
}

function respawnBase() {
    if(!game.house.active) return;
    game.player.x = game.house.x;
    game.player.y = game.house.y;
    game.player.hp = game.player.maxHp;
    isGameRunning = true;
    document.getElementById('death-screen').style.display = 'none';
    loop(performance.now());
}

function toggleMenu(state) {
    isMenuOpen = (state!==undefined) ? state : !isMenuOpen;
    document.getElementById('craft-menu').style.display = isMenuOpen ? 'block' : 'none';
    if(isMenuOpen) updateUI();
}

function toggleMinimap() {
    isMinimapOpen = !isMinimapOpen;
    document.getElementById('minimap-container').style.display = isMinimapOpen ? 'block' : 'none';
}

function setupInputs() {
    window.addEventListener('keydown', e => {
        if (e.code === 'Tab') { e.preventDefault(); toggleMenu(); }
        if (e.code === 'CapsLock') { e.preventDefault(); toggleMinimap(); }
        keys[e.code] = true;
    });
    window.addEventListener('keyup', e => keys[e.code] = false);
    canvas.addEventListener('mousedown', e => { if (e.button === 0) handleAction(); });
}

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize);

init();

</script>
</body>
</html>
